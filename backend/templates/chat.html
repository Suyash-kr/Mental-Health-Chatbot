<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindNest Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for chat */
    #chat-box::-webkit-scrollbar {
      width: 6px;
    }
    #chat-box::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    #chat-box::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 3px;
    }
    .dark #chat-box::-webkit-scrollbar-track {
      background: #374151;
    }
    .dark #chat-box::-webkit-scrollbar-thumb {
      background: #6b7280;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col h-screen text-gray-900 dark:text-gray-100 transition-colors duration-300">

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="MindNest Logo" class="w-8 h-8">
      <span class="font-bold text-xl">MindNest</span>
    </div>
    <div class="flex items-center space-x-4">
      <a href="{{ url_for('home') }}" 
         class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
         ‚Üê Back to Home
      </a>
    </div>
  </header>

  <!-- Chat Container -->
  <main id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4">
    <!-- Initial welcome message -->
    <div class="flex items-end space-x-2 justify-start">
      <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-500 text-white">ü§ñ</div>
      <div class="inline-block max-w-xs px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">
        Hello! I'm here to listen. How are you feeling today?
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ now.strftime('%H:%M') if now else 'Just now' }}</div>
    </div>
  </main>

  <!-- Input Area -->
  <footer class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4">
    <div class="flex items-center space-x-2">
      <input 
        id="user-input"
        type="text"
        placeholder="Type your message..."
        class="flex-1 border dark:border-gray-600 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
        autocomplete="off"
      />
      <button 
        id="send-btn"
        onclick="sendMessage()" 
        class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 flex items-center justify-center transition-colors"
      >
        <span id="send-text">Send</span>
        <span id="send-loader" class="hidden ml-2">
          <svg class="w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </button>
    </div>

    <!-- Quick Replies -->
    <div class="mt-3 flex flex-wrap gap-2">
      <button onclick="quickReply('I feel stressed today')" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">I feel stressed</button>
      <button onclick="quickReply('I need some positive encouragement')" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Need encouragement</button>
      <button onclick="quickReply('How can I manage anxiety?')" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Manage anxiety</button>
    </div>
  </footer>

  <script>
    const chatBox = document.getElementById("chat-box");
    const inputField = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const sendText = document.getElementById("send-text");
    const sendLoader = document.getElementById("send-loader");

    // Focus input on load
    window.onload = function() {
      inputField.focus();
    };

    function appendMessage(sender, text, isTyping = false) {
      const msgDiv = document.createElement("div");
      msgDiv.className = `flex items-end space-x-2 ${sender === "user" ? "justify-end" : "justify-start"}`;

      const bubble = document.createElement("div");
      bubble.className = `inline-block max-w-xs px-4 py-2 rounded-lg ${
        sender === "user" 
          ? "bg-blue-600 text-white rounded-br-none" 
          : "bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none"
      }`;

      if (isTyping) {
        bubble.innerHTML = `
          <div class="flex space-x-1">
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
          </div>
        `;
      } else {
        bubble.textContent = text;
      }

      const timestamp = document.createElement("div");
      timestamp.className = "text-xs text-gray-500 dark:text-gray-400 mt-1";
      timestamp.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      const avatar = document.createElement("div");
      avatar.className = `w-8 h-8 rounded-full flex items-center justify-center text-white ${
        sender === "user" ? "bg-gray-400" : "bg-blue-500"
      }`;
      avatar.textContent = sender === "user" ? "üë§" : "ü§ñ";

      if (sender === "user") {
        msgDiv.appendChild(avatar);
        msgDiv.appendChild(bubble);
        msgDiv.appendChild(timestamp);
      } else {
        msgDiv.appendChild(avatar);
        msgDiv.appendChild(bubble);
        msgDiv.appendChild(timestamp);
      }

      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.id = "typing-indicator";
      typingDiv.className = "flex items-end space-x-2 justify-start";
      typingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-500 text-white">ü§ñ</div>
        <div class="inline-block max-w-xs px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none">
          <div class="flex space-x-1">
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-gray-500 dark:bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
          </div>
        </div>
      `;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return typingDiv;
    }

    async function sendMessage() {
      const userMsg = inputField.value.trim();
      if (!userMsg) return;

      // Disable input and button while processing
      inputField.disabled = true;
      sendBtn.disabled = true;
      
      appendMessage("user", userMsg);
      inputField.value = "";

      sendText.classList.add("hidden");
      sendLoader.classList.remove("hidden");

      const typingIndicator = showTypingIndicator();

      try {
        const res = await fetch("{{ url_for('get_response') }}", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ message: userMsg }),
        });

        if (!res.ok) {
          throw new Error(`Server responded with ${res.status}`);
        }

        const data = await res.json();
        typingIndicator.remove();
        appendMessage("bot", data.reply);
      } catch (err) {
        console.error("Error:", err);
        typingIndicator.remove();
        appendMessage("bot", "I'm having trouble connecting right now. Please try again in a moment.");
      }

      sendText.classList.remove("hidden");
      sendLoader.classList.add("hidden");
      inputField.disabled = false;
      sendBtn.disabled = false;
      inputField.focus();
    }

    function quickReply(text) {
      inputField.value = text;
      sendMessage();
    }

    inputField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Add a simple notification for users
    setTimeout(() => {
      const notification = document.createElement("div");
      notification.className = "fixed bottom-4 right-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded shadow-md max-w-xs hidden";
      notification.id = "privacy-notification";
      notification.innerHTML = `
        <p class="text-sm">Your conversations are private and anonymous. We care about your privacy.</p>
        <button class="absolute top-1 right-2 text-blue-700" onclick="document.getElementById('privacy-notification').classList.add('hidden')">
          &times;
        </button>
      `;
      document.body.appendChild(notification);
      notification.classList.remove('hidden');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 5000);
    }, 2000);
  </script>
</body>
</html>